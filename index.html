<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml"> 
<head> 
<title>Componsizione Acque Comune di Trento</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />

<style type="text/css">
#map {
	position: absolute;
	width: 100%;
	height: 100%;
}
</style>
</head> 	
<body>

<div id="map"></div>

<script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
<script src="https://unpkg.com/underscore@1.8.3/underscore.js"></script>
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet-src.js"></script>
<script src="https://unpkg.com/leaflet.timeline@1.2.1/dist/leaflet.timeline.js"></script>
<script>

var map = new L.Map('map', {
		zoom: 13,
		center: new L.latLng([46.07,11.1]),
		layers: L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
	});

	var url = "https://api.apify.com/v1/execs/KTFWTkmxttzFs4SgH/results";
var geo;
	$.getJSON(url, function(json) {

		var data = json[0].pageFunctionResult

		geo = L.geoJSON(null,{
				pointToLayer: function(f, latlng) {
					var m = L.circleMarker(latlng,{ radius: 10 });
					m.bindPopup(JSON.stringify(f.properties));
					return m;
				}
			});
		//geo.addTo(map);

		var rdata = _.map(data.locs, function(v,k) {
			var m = L.marker(v);

			var point = m.toGeoJSON();
			point.properties = {
				name: data.names[k],
				date: data.dates[k].split('-').reverse().join('-'),
				values: _.object(data.params, data.values[k])
			};
			
			geo.addData(point);
		});

		var geojson = geo.toGeoJSON();

        var timelineControl = L.timelineSliderControl({
/*          formatOutput: function(date) {
          	console.log(date)
            return new Date(date).toString();
          }*/
        });

        var timeline = L.timeline(geojson, {
/*          getInterval: function(f) {
          	console.log(f.properties.date)
			return {
				start: f.properties.date
			};
          },*/
          formatDate: function(date) {
			console.log(date)
			return new Date(date).toString();
          },
          pointToLayer: function(data, latlng) {
            //var hue_min = 120;
            //var hue_max = 0;
            //var hue = data.properties.mag / 10 * (hue_max - hue_min) + hue_min;
            return L.circleMarker(latlng, {
              radius: 10,//data.properties.mag * 3,
              //color: "hsl("+hue+", 100%, 50%)",
              //fillColor: "hsl("+hue+", 100%, 50%)"
            })//.bindPopup(JSON.stringify(data.properties));
          }
        });
        timelineControl.addTo(map)
        timelineControl.addTimelines(timeline);
        timeline.addTo(map);
	});
</script>
</body>
</html>
